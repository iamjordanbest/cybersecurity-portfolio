import xml.etree.ElementTree as ET
import csv
import logging
from typing import List, Dict, Any
from datetime import datetime

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class VulnerabilityParser:
    """
    Parses vulnerability scan data from various formats (Nessus, OpenVAS, CSV).
    """
    
    def __init__(self):
        self.findings = []
        
    def parse_nessus(self, filepath: str) -> List[Dict[str, Any]]:
        """Parse Nessus XML export."""
        logger.info(f"Parsing Nessus file: {filepath}")
        findings = []
        try:
            tree = ET.parse(filepath)
            root = tree.getroot()
            
            for report_host in root.findall('.//ReportHost'):
                host_ip = report_host.get('name')
                
                for item in report_host.findall('ReportItem'):
                    # Filter out informational (Severity 0)
                    severity = int(item.get('severity'))
                    if severity > 0:
                        findings.append({
                            'host': host_ip,
                            'plugin_id': item.get('pluginID'),
                            'plugin_name': item.get('pluginName'),
                            'severity': severity,
                            'protocol': item.get('protocol'),
                            'port': item.get('port'),
                            'description': item.find('description').text if item.find('description') is not None else '',
                            'solution': item.find('solution').text if item.find('solution') is not None else '',
                            'source': 'nessus'
                        })
        except Exception as e:
            logger.error(f"Error parsing Nessus file: {e}")
            
        return findings

    def parse_csv(self, filepath: str) -> List[Dict[str, Any]]:
        """Parse generic CSV vulnerability list."""
        logger.info(f"Parsing CSV file: {filepath}")
        findings = []
        try:
            with open(filepath, 'r') as f:
                reader = csv.DictReader(f)
                for row in reader:
                    findings.append({
                        'host': row.get('Host') or row.get('IP Address'),
                        'plugin_name': row.get('Name') or row.get('Title'),
                        'severity': row.get('Severity'),
                        'description': row.get('Description'),
                        'source': 'csv'
                    })
        except Exception as e:
            logger.error(f"Error parsing CSV file: {e}")
            
        return findings

    def normalize_findings(self, raw_findings: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """Normalize findings into a standard format."""
        normalized = []
        for f in raw_findings:
            # Map severity to standard levels
            sev_map = {4: 'Critical', 3: 'High', 2: 'Medium', 1: 'Low'}
            severity_label = sev_map.get(f.get('severity'), str(f.get('severity')))
            
            normalized.append({
                'id': f"{f.get('host')}:{f.get('plugin_id', 'unknown')}",
                'host': f.get('host'),
                'title': f.get('plugin_name'),
                'severity': severity_label,
                'description': f.get('description')[:200] + "..." if f.get('description') else "",
                'status': 'Open',
                'first_seen': datetime.now().isoformat()
            })
        return normalized

if __name__ == "__main__":
    # Example usage
    parser = VulnerabilityParser()
    print("Vulnerability Parser initialized.")
    print("Use parse_nessus() or parse_csv() to import data.")
